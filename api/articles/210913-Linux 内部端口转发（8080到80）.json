{"title":"Linux 内部端口转发","slug":"210913-Linux 内部端口转发（8080到80）","date":"2021-09-14T04:00:00.000Z","updated":"2023-12-22T08:04:15.777Z","comments":true,"path":"api/articles/210913-Linux 内部端口转发（8080到80）.json","realPath":null,"excerpt":"实现外网访问80端口，由内部转发至8080端口","covers":null,"cover":"https://pic.wuzhiping.top/blog/202109141811381.png","content":"<h2 id=\"问题背景\"><a href=\"#问题背景\" class=\"headerlink\" title=\"问题背景\"></a>问题背景</h2><p>通过 <code>frp</code> + <code>docker</code> 实现了外网访问小主机的 nextcloud 云盘（开放8080端口），问题在于 80 端口被占用，只好用域名+端口的形式来实现访问，如 <code>xxx.wuzhiping.top:8080</code>，不够优雅，想把域名后面的端口号直接去除。<br>一顿查阅各种资料，找到了 Linux 内部端口转发的方法，即外部访问80端口时（ http 域名的默认端口）内部转发到8080端口，实现不填写端口号即可访问。</p>\n<h2 id=\"环境简述\"><a href=\"#环境简述\" class=\"headerlink\" title=\"环境简述\"></a>环境简述</h2><ul>\n<li>本地主机：docker 搭建了 nextcloud 服务</li>\n<li>远程主机：阿里云服务器，固定ip，Ubuntu21 系统</li>\n<li>远程访问：frp 实现二级域名转发到本地主机上的 nextcloud（云主机8080端口映射本地主机 nextcloud 的端口）</li>\n<li>iptables 如未安装，可通过命令 <code>sudo apt install iptables-services</code></li>\n</ul>\n<h2 id=\"关键步骤\"><a href=\"#关键步骤\" class=\"headerlink\" title=\"关键步骤\"></a>关键步骤</h2><ol>\n<li>准备：释放内部端口转发的功能</li>\n</ol>\n<p>编辑 <code>/etc/sysctl.conf</code>,取消这一行的注释</p>\n<figure class=\"highlight txt\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs txt\">#net.ipv4.ip_forward=1<br></code></pre></td></tr></table></figure>\n<ol start=\"2\">\n<li>保存并验证上一步的操作</li>\n</ol>\n<p>保存文件，通过命令确认是否生效，打印出的是 <code>net.ipv4.ip_forward=1</code> 即生效</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">sudo sysctl -p<br></code></pre></td></tr></table></figure>\n\n<ol start=\"3\">\n<li>手动操作内部端口转发</li>\n</ol>\n<p>基本命令及释义：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">iptable -t nat -A  PREROUTING -p tcp --dport  <span class=\"hljs-string\">&quot;<svg xmlns:xlink=\"http://www.w3.org/1999/xlink\" width=\"40.746ex\" height=\"3.343ex\" style=\"vertical-align: -1.171ex;\" viewBox=\"0 -934.9 17543.3 1439.2\" role=\"img\" focusable=\"false\" xmlns=\"http://www.w3.org/2000/svg\" aria-labelledby=\"MathJax-SVG-1-Title\">\n<title id=\"MathJax-SVG-1-Title\">原端口\"  -j  REDIRECT --to-port  \"</title>\n<defs aria-hidden=\"true\">\n<path stroke-width=\"1\" id=\"E1-MJMAIN-22\" d=\"M34 634Q34 659 50 676T93 694Q121 694 144 668T168 579Q168 525 146 476T101 403T73 379Q69 379 60 388T50 401Q50 404 62 417T88 448T116 500T131 572Q131 584 130 584T125 581T112 576T94 573Q69 573 52 590T34 634ZM238 634Q238 659 254 676T297 694Q325 694 348 668T372 579Q372 525 350 476T305 403T277 379Q273 379 264 388T254 401Q254 404 266 417T292 448T320 500T335 572Q335 584 334 584T329 581T316 576T298 573Q273 573 256 590T238 634Z\"></path>\n<path stroke-width=\"1\" id=\"E1-MJMAIN-2212\" d=\"M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z\"></path>\n<path stroke-width=\"1\" id=\"E1-MJMATHI-6A\" d=\"M297 596Q297 627 318 644T361 661Q378 661 389 651T403 623Q403 595 384 576T340 557Q322 557 310 567T297 596ZM288 376Q288 405 262 405Q240 405 220 393T185 362T161 325T144 293L137 279Q135 278 121 278H107Q101 284 101 286T105 299Q126 348 164 391T252 441Q253 441 260 441T272 442Q296 441 316 432Q341 418 354 401T367 348V332L318 133Q267 -67 264 -75Q246 -125 194 -164T75 -204Q25 -204 7 -183T-12 -137Q-12 -110 7 -91T53 -71Q70 -71 82 -81T95 -112Q95 -148 63 -167Q69 -168 77 -168Q111 -168 139 -140T182 -74L193 -32Q204 11 219 72T251 197T278 308T289 365Q289 372 288 376Z\"></path>\n<path stroke-width=\"1\" id=\"E1-MJMATHI-52\" d=\"M230 637Q203 637 198 638T193 649Q193 676 204 682Q206 683 378 683Q550 682 564 680Q620 672 658 652T712 606T733 563T739 529Q739 484 710 445T643 385T576 351T538 338L545 333Q612 295 612 223Q612 212 607 162T602 80V71Q602 53 603 43T614 25T640 16Q668 16 686 38T712 85Q717 99 720 102T735 105Q755 105 755 93Q755 75 731 36Q693 -21 641 -21H632Q571 -21 531 4T487 82Q487 109 502 166T517 239Q517 290 474 313Q459 320 449 321T378 323H309L277 193Q244 61 244 59Q244 55 245 54T252 50T269 48T302 46H333Q339 38 339 37T336 19Q332 6 326 0H311Q275 2 180 2Q146 2 117 2T71 2T50 1Q33 1 33 10Q33 12 36 24Q41 43 46 45Q50 46 61 46H67Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628Q287 635 230 637ZM630 554Q630 586 609 608T523 636Q521 636 500 636T462 637H440Q393 637 386 627Q385 624 352 494T319 361Q319 360 388 360Q466 361 492 367Q556 377 592 426Q608 449 619 486T630 554Z\"></path>\n<path stroke-width=\"1\" id=\"E1-MJMATHI-45\" d=\"M492 213Q472 213 472 226Q472 230 477 250T482 285Q482 316 461 323T364 330H312Q311 328 277 192T243 52Q243 48 254 48T334 46Q428 46 458 48T518 61Q567 77 599 117T670 248Q680 270 683 272Q690 274 698 274Q718 274 718 261Q613 7 608 2Q605 0 322 0H133Q31 0 31 11Q31 13 34 25Q38 41 42 43T65 46Q92 46 125 49Q139 52 144 61Q146 66 215 342T285 622Q285 629 281 629Q273 632 228 634H197Q191 640 191 642T193 659Q197 676 203 680H757Q764 676 764 669Q764 664 751 557T737 447Q735 440 717 440H705Q698 445 698 453L701 476Q704 500 704 528Q704 558 697 578T678 609T643 625T596 632T532 634H485Q397 633 392 631Q388 629 386 622Q385 619 355 499T324 377Q347 376 372 376H398Q464 376 489 391T534 472Q538 488 540 490T557 493Q562 493 565 493T570 492T572 491T574 487T577 483L544 351Q511 218 508 216Q505 213 492 213Z\"></path>\n<path stroke-width=\"1\" id=\"E1-MJMATHI-44\" d=\"M287 628Q287 635 230 637Q207 637 200 638T193 647Q193 655 197 667T204 682Q206 683 403 683Q570 682 590 682T630 676Q702 659 752 597T803 431Q803 275 696 151T444 3L430 1L236 0H125H72Q48 0 41 2T33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM703 469Q703 507 692 537T666 584T629 613T590 629T555 636Q553 636 541 636T512 636T479 637H436Q392 637 386 627Q384 623 313 339T242 52Q242 48 253 48T330 47Q335 47 349 47T373 46Q499 46 581 128Q617 164 640 212T683 339T703 469Z\"></path>\n<path stroke-width=\"1\" id=\"E1-MJMATHI-49\" d=\"M43 1Q26 1 26 10Q26 12 29 24Q34 43 39 45Q42 46 54 46H60Q120 46 136 53Q137 53 138 54Q143 56 149 77T198 273Q210 318 216 344Q286 624 286 626Q284 630 284 631Q274 637 213 637H193Q184 643 189 662Q193 677 195 680T209 683H213Q285 681 359 681Q481 681 487 683H497Q504 676 504 672T501 655T494 639Q491 637 471 637Q440 637 407 634Q393 631 388 623Q381 609 337 432Q326 385 315 341Q245 65 245 59Q245 52 255 50T307 46H339Q345 38 345 37T342 19Q338 6 332 0H316Q279 2 179 2Q143 2 113 2T65 2T43 1Z\"></path>\n<path stroke-width=\"1\" id=\"E1-MJMATHI-43\" d=\"M50 252Q50 367 117 473T286 641T490 704Q580 704 633 653Q642 643 648 636T656 626L657 623Q660 623 684 649Q691 655 699 663T715 679T725 690L740 705H746Q760 705 760 698Q760 694 728 561Q692 422 692 421Q690 416 687 415T669 413H653Q647 419 647 422Q647 423 648 429T650 449T651 481Q651 552 619 605T510 659Q484 659 454 652T382 628T299 572T226 479Q194 422 175 346T156 222Q156 108 232 58Q280 24 350 24Q441 24 512 92T606 240Q610 253 612 255T628 257Q648 257 648 248Q648 243 647 239Q618 132 523 55T319 -22Q206 -22 128 53T50 252Z\"></path>\n<path stroke-width=\"1\" id=\"E1-MJMATHI-54\" d=\"M40 437Q21 437 21 445Q21 450 37 501T71 602L88 651Q93 669 101 677H569H659Q691 677 697 676T704 667Q704 661 687 553T668 444Q668 437 649 437Q640 437 637 437T631 442L629 445Q629 451 635 490T641 551Q641 586 628 604T573 629Q568 630 515 631Q469 631 457 630T439 622Q438 621 368 343T298 60Q298 48 386 46Q418 46 427 45T436 36Q436 31 433 22Q429 4 424 1L422 0Q419 0 415 0Q410 0 363 1T228 2Q99 2 64 0H49Q43 6 43 9T45 27Q49 40 55 46H83H94Q174 46 189 55Q190 56 191 56Q196 59 201 76T241 233Q258 301 269 344Q339 619 339 625Q339 630 310 630H279Q212 630 191 624Q146 614 121 583T67 467Q60 445 57 441T43 437H40Z\"></path>\n<path stroke-width=\"1\" id=\"E1-MJMATHI-74\" d=\"M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z\"></path>\n<path stroke-width=\"1\" id=\"E1-MJMATHI-6F\" d=\"M201 -11Q126 -11 80 38T34 156Q34 221 64 279T146 380Q222 441 301 441Q333 441 341 440Q354 437 367 433T402 417T438 387T464 338T476 268Q476 161 390 75T201 -11ZM121 120Q121 70 147 48T206 26Q250 26 289 58T351 142Q360 163 374 216T388 308Q388 352 370 375Q346 405 306 405Q243 405 195 347Q158 303 140 230T121 120Z\"></path>\n<path stroke-width=\"1\" id=\"E1-MJMATHI-70\" d=\"M23 287Q24 290 25 295T30 317T40 348T55 381T75 411T101 433T134 442Q209 442 230 378L240 387Q302 442 358 442Q423 442 460 395T497 281Q497 173 421 82T249 -10Q227 -10 210 -4Q199 1 187 11T168 28L161 36Q160 35 139 -51T118 -138Q118 -144 126 -145T163 -148H188Q194 -155 194 -157T191 -175Q188 -187 185 -190T172 -194Q170 -194 161 -194T127 -193T65 -192Q-5 -192 -24 -194H-32Q-39 -187 -39 -183Q-37 -156 -26 -148H-6Q28 -147 33 -136Q36 -130 94 103T155 350Q156 355 156 364Q156 405 131 405Q109 405 94 377T71 316T59 280Q57 278 43 278H29Q23 284 23 287ZM178 102Q200 26 252 26Q282 26 310 49T356 107Q374 141 392 215T411 325V331Q411 405 350 405Q339 405 328 402T306 393T286 380T269 365T254 350T243 336T235 326L232 322Q232 321 229 308T218 264T204 212Q178 106 178 102Z\"></path>\n<path stroke-width=\"1\" id=\"E1-MJMATHI-72\" d=\"M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q161 442 183 430T214 408T225 388Q227 382 228 382T236 389Q284 441 347 441H350Q398 441 422 400Q430 381 430 363Q430 333 417 315T391 292T366 288Q346 288 334 299T322 328Q322 376 378 392Q356 405 342 405Q286 405 239 331Q229 315 224 298T190 165Q156 25 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z\"></path>\n</defs>\n<g stroke=\"currentColor\" fill=\"currentColor\" stroke-width=\"0\" transform=\"matrix(1 0 0 -1 0 0)\" aria-hidden=\"true\">\n<text font-family=\"monospace\" stroke=\"none\" transform=\"scale(71.759) matrix(1 0 0 -1 0 0)\">原</text>\n<g transform=\"translate(932,0)\">\n<text font-family=\"monospace\" stroke=\"none\" transform=\"scale(71.759) matrix(1 0 0 -1 0 0)\">端</text>\n</g>\n<g transform=\"translate(1865,0)\">\n<text font-family=\"monospace\" stroke=\"none\" transform=\"scale(71.759) matrix(1 0 0 -1 0 0)\">口</text>\n</g>\n <use xlink:href=\"#E1-MJMAIN-22\" x=\"3076\" y=\"0\"></use>\n <use xlink:href=\"#E1-MJMAIN-2212\" x=\"3854\" y=\"0\"></use>\n <use xlink:href=\"#E1-MJMATHI-6A\" x=\"4633\" y=\"0\"></use>\n <use xlink:href=\"#E1-MJMATHI-52\" x=\"5045\" y=\"0\"></use>\n <use xlink:href=\"#E1-MJMATHI-45\" x=\"5805\" y=\"0\"></use>\n <use xlink:href=\"#E1-MJMATHI-44\" x=\"6569\" y=\"0\"></use>\n <use xlink:href=\"#E1-MJMATHI-49\" x=\"7398\" y=\"0\"></use>\n <use xlink:href=\"#E1-MJMATHI-52\" x=\"7902\" y=\"0\"></use>\n <use xlink:href=\"#E1-MJMATHI-45\" x=\"8662\" y=\"0\"></use>\n <use xlink:href=\"#E1-MJMATHI-43\" x=\"9426\" y=\"0\"></use>\n <use xlink:href=\"#E1-MJMATHI-54\" x=\"10187\" y=\"0\"></use>\n <use xlink:href=\"#E1-MJMAIN-2212\" x=\"11113\" y=\"0\"></use>\n <use xlink:href=\"#E1-MJMAIN-2212\" x=\"12114\" y=\"0\"></use>\n <use xlink:href=\"#E1-MJMATHI-74\" x=\"12893\" y=\"0\"></use>\n <use xlink:href=\"#E1-MJMATHI-6F\" x=\"13254\" y=\"0\"></use>\n <use xlink:href=\"#E1-MJMAIN-2212\" x=\"13962\" y=\"0\"></use>\n <use xlink:href=\"#E1-MJMATHI-70\" x=\"14963\" y=\"0\"></use>\n <use xlink:href=\"#E1-MJMATHI-6F\" x=\"15466\" y=\"0\"></use>\n <use xlink:href=\"#E1-MJMATHI-72\" x=\"15952\" y=\"0\"></use>\n <use xlink:href=\"#E1-MJMATHI-74\" x=\"16403\" y=\"0\"></use>\n <use xlink:href=\"#E1-MJMAIN-22\" x=\"17042\" y=\"0\"></use>\n</g>\n</svg>目标端口&quot;</span><br></code></pre></td></tr></table></figure>\n\n<blockquote>\n<p><strong>参数释义：</strong><br>-t: table  table to manipulate (default: &#96;filter’)<br>-A: 向规则链中添加条目<br>PREROUTING链：用于目标地址转换（DNAT），路由前。<br>-p：指定要匹配的数据包协议类型；<br>–dport: 目的端口，即客户端要访问的端口<br>-j: jump 指定要跳转的目标<br>REDIRECT: 重定向、映射、透明代理<br>–to-port: 跳转到的端口号</p>\n</blockquote>\n<p>以本次要解决的问题为例，外网输入网址–访问80端口–内部转发至8080端口–获取对 nextcloud 服务的访问</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">iptables -t nat -A PREROUTING -p tcp --dport 80 -j REDIRECT --to-port 8080<br></code></pre></td></tr></table></figure>\n\n<p>保存配置</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">service iptables save<br></code></pre></td></tr></table></figure>\n\n<ol start=\"4\">\n<li>查询与撤销操作</li>\n</ol>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">sudo iptables -t nat -nL --line<br></code></pre></td></tr></table></figure>\n\n<p>找到 <code>Chain PREROUTING (policy ACCEPT)</code> 这一栏，注意查看 <code>num</code> 序号</p>\n<p>删除指定表的指定链上的规则， -D 并指定对应序号即可（对应的序号会及时变动）。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">iptables -t nat -D PREROUTING 1<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"彩蛋：高级玩法\"><a href=\"#彩蛋：高级玩法\" class=\"headerlink\" title=\"彩蛋：高级玩法\"></a>彩蛋：高级玩法</h2><p>一点小思考：明白了内网中转的办法，想到一个场景，通过一台远程主机管理另一台远程主机，相当于一台跳板，不过前提是两台主机都要有固定 ip 才行吧！</p>\n<p>要是未来 ipv6 全面普及了，估计能解放不少生产力！</p>\n<p>这个网站可以测测自己是不是有 ipv6地址：<a target=\"_blank\" rel=\"noopener\" href=\"https://www.test-ipv6.com/\">IPv6 测试</a></p>\n<h2 id=\"Ref\"><a href=\"#Ref\" class=\"headerlink\" title=\"Ref\"></a>Ref</h2><ul>\n<li><a target=\"_blank\" rel=\"noopener\" href=\"https://zhuanlan.zhihu.com/p/165043421\">linux中通过iptables实现端口转发 - 知乎</a></li>\n<li><a target=\"_blank\" rel=\"noopener\" href=\"https://blog.csdn.net/qq_31586935/article/details/89446612\">Linux将8080端口转发到80端口_Evanism_小风铃的博客-CSDN博客</a></li>\n<li><a target=\"_blank\" rel=\"noopener\" href=\"https://www.cnblogs.com/xiaopaipai/p/11733291.html\">iptable实现端口转发 - 博客园</a></li>\n<li><a target=\"_blank\" rel=\"noopener\" href=\"https://blog.csdn.net/zhouguoqionghai/article/details/81947603\">iptables 端口转发_zhouguoqionghai的博客-CSDN博客</a></li>\n<li><a target=\"_blank\" rel=\"noopener\" href=\"https://blog.csdn.net/ZhouGuo520/article/details/111227084\">Linux 操作系统防火墙之iptables配置（centos系列）</a></li>\n</ul>\n<h2 id=\"Changelog\"><a href=\"#Changelog\" class=\"headerlink\" title=\"Changelog\"></a>Changelog</h2><ul>\n<li>210913 米斯特乌建立初稿</li>\n</ul>\n","more":"<h2 id=\"问题背景\"><a href=\"#问题背景\" class=\"headerlink\" title=\"问题背景\"></a>问题背景</h2><p>通过 <code>frp</code> + <code>docker</code> 实现了外网访问小主机的 nextcloud 云盘（开放8080端口），问题在于 80 端口被占用，只好用域名+端口的形式来实现访问，如 <code>xxx.wuzhiping.top:8080</code>，不够优雅，想把域名后面的端口号直接去除。<br>一顿查阅各种资料，找到了 Linux 内部端口转发的方法，即外部访问80端口时（ http 域名的默认端口）内部转发到8080端口，实现不填写端口号即可访问。</p>\n<h2 id=\"环境简述\"><a href=\"#环境简述\" class=\"headerlink\" title=\"环境简述\"></a>环境简述</h2><ul>\n<li>本地主机：docker 搭建了 nextcloud 服务</li>\n<li>远程主机：阿里云服务器，固定ip，Ubuntu21 系统</li>\n<li>远程访问：frp 实现二级域名转发到本地主机上的 nextcloud（云主机8080端口映射本地主机 nextcloud 的端口）</li>\n<li>iptables 如未安装，可通过命令 <code>sudo apt install iptables-services</code></li>\n</ul>\n<h2 id=\"关键步骤\"><a href=\"#关键步骤\" class=\"headerlink\" title=\"关键步骤\"></a>关键步骤</h2><ol>\n<li>准备：释放内部端口转发的功能</li>\n</ol>\n<p>编辑 <code>/etc/sysctl.conf</code>,取消这一行的注释</p>\n<figure class=\"highlight txt\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs txt\">#net.ipv4.ip_forward=1<br></code></pre></td></tr></table></figure>\n<ol start=\"2\">\n<li>保存并验证上一步的操作</li>\n</ol>\n<p>保存文件，通过命令确认是否生效，打印出的是 <code>net.ipv4.ip_forward=1</code> 即生效</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">sudo sysctl -p<br></code></pre></td></tr></table></figure>\n\n<ol start=\"3\">\n<li>手动操作内部端口转发</li>\n</ol>\n<p>基本命令及释义：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">iptable -t nat -A  PREROUTING -p tcp --dport  <span class=\"hljs-string\">&quot;<svg xmlns:xlink=\"http://www.w3.org/1999/xlink\" width=\"40.746ex\" height=\"3.343ex\" style=\"vertical-align: -1.171ex;\" viewBox=\"0 -934.9 17543.3 1439.2\" role=\"img\" focusable=\"false\" xmlns=\"http://www.w3.org/2000/svg\" aria-labelledby=\"MathJax-SVG-1-Title\">\n<title id=\"MathJax-SVG-1-Title\">原端口\"  -j  REDIRECT --to-port  \"</title>\n<defs aria-hidden=\"true\">\n<path stroke-width=\"1\" id=\"E1-MJMAIN-22\" d=\"M34 634Q34 659 50 676T93 694Q121 694 144 668T168 579Q168 525 146 476T101 403T73 379Q69 379 60 388T50 401Q50 404 62 417T88 448T116 500T131 572Q131 584 130 584T125 581T112 576T94 573Q69 573 52 590T34 634ZM238 634Q238 659 254 676T297 694Q325 694 348 668T372 579Q372 525 350 476T305 403T277 379Q273 379 264 388T254 401Q254 404 266 417T292 448T320 500T335 572Q335 584 334 584T329 581T316 576T298 573Q273 573 256 590T238 634Z\"></path>\n<path stroke-width=\"1\" id=\"E1-MJMAIN-2212\" d=\"M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z\"></path>\n<path stroke-width=\"1\" id=\"E1-MJMATHI-6A\" d=\"M297 596Q297 627 318 644T361 661Q378 661 389 651T403 623Q403 595 384 576T340 557Q322 557 310 567T297 596ZM288 376Q288 405 262 405Q240 405 220 393T185 362T161 325T144 293L137 279Q135 278 121 278H107Q101 284 101 286T105 299Q126 348 164 391T252 441Q253 441 260 441T272 442Q296 441 316 432Q341 418 354 401T367 348V332L318 133Q267 -67 264 -75Q246 -125 194 -164T75 -204Q25 -204 7 -183T-12 -137Q-12 -110 7 -91T53 -71Q70 -71 82 -81T95 -112Q95 -148 63 -167Q69 -168 77 -168Q111 -168 139 -140T182 -74L193 -32Q204 11 219 72T251 197T278 308T289 365Q289 372 288 376Z\"></path>\n<path stroke-width=\"1\" id=\"E1-MJMATHI-52\" d=\"M230 637Q203 637 198 638T193 649Q193 676 204 682Q206 683 378 683Q550 682 564 680Q620 672 658 652T712 606T733 563T739 529Q739 484 710 445T643 385T576 351T538 338L545 333Q612 295 612 223Q612 212 607 162T602 80V71Q602 53 603 43T614 25T640 16Q668 16 686 38T712 85Q717 99 720 102T735 105Q755 105 755 93Q755 75 731 36Q693 -21 641 -21H632Q571 -21 531 4T487 82Q487 109 502 166T517 239Q517 290 474 313Q459 320 449 321T378 323H309L277 193Q244 61 244 59Q244 55 245 54T252 50T269 48T302 46H333Q339 38 339 37T336 19Q332 6 326 0H311Q275 2 180 2Q146 2 117 2T71 2T50 1Q33 1 33 10Q33 12 36 24Q41 43 46 45Q50 46 61 46H67Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628Q287 635 230 637ZM630 554Q630 586 609 608T523 636Q521 636 500 636T462 637H440Q393 637 386 627Q385 624 352 494T319 361Q319 360 388 360Q466 361 492 367Q556 377 592 426Q608 449 619 486T630 554Z\"></path>\n<path stroke-width=\"1\" id=\"E1-MJMATHI-45\" d=\"M492 213Q472 213 472 226Q472 230 477 250T482 285Q482 316 461 323T364 330H312Q311 328 277 192T243 52Q243 48 254 48T334 46Q428 46 458 48T518 61Q567 77 599 117T670 248Q680 270 683 272Q690 274 698 274Q718 274 718 261Q613 7 608 2Q605 0 322 0H133Q31 0 31 11Q31 13 34 25Q38 41 42 43T65 46Q92 46 125 49Q139 52 144 61Q146 66 215 342T285 622Q285 629 281 629Q273 632 228 634H197Q191 640 191 642T193 659Q197 676 203 680H757Q764 676 764 669Q764 664 751 557T737 447Q735 440 717 440H705Q698 445 698 453L701 476Q704 500 704 528Q704 558 697 578T678 609T643 625T596 632T532 634H485Q397 633 392 631Q388 629 386 622Q385 619 355 499T324 377Q347 376 372 376H398Q464 376 489 391T534 472Q538 488 540 490T557 493Q562 493 565 493T570 492T572 491T574 487T577 483L544 351Q511 218 508 216Q505 213 492 213Z\"></path>\n<path stroke-width=\"1\" id=\"E1-MJMATHI-44\" d=\"M287 628Q287 635 230 637Q207 637 200 638T193 647Q193 655 197 667T204 682Q206 683 403 683Q570 682 590 682T630 676Q702 659 752 597T803 431Q803 275 696 151T444 3L430 1L236 0H125H72Q48 0 41 2T33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM703 469Q703 507 692 537T666 584T629 613T590 629T555 636Q553 636 541 636T512 636T479 637H436Q392 637 386 627Q384 623 313 339T242 52Q242 48 253 48T330 47Q335 47 349 47T373 46Q499 46 581 128Q617 164 640 212T683 339T703 469Z\"></path>\n<path stroke-width=\"1\" id=\"E1-MJMATHI-49\" d=\"M43 1Q26 1 26 10Q26 12 29 24Q34 43 39 45Q42 46 54 46H60Q120 46 136 53Q137 53 138 54Q143 56 149 77T198 273Q210 318 216 344Q286 624 286 626Q284 630 284 631Q274 637 213 637H193Q184 643 189 662Q193 677 195 680T209 683H213Q285 681 359 681Q481 681 487 683H497Q504 676 504 672T501 655T494 639Q491 637 471 637Q440 637 407 634Q393 631 388 623Q381 609 337 432Q326 385 315 341Q245 65 245 59Q245 52 255 50T307 46H339Q345 38 345 37T342 19Q338 6 332 0H316Q279 2 179 2Q143 2 113 2T65 2T43 1Z\"></path>\n<path stroke-width=\"1\" id=\"E1-MJMATHI-43\" d=\"M50 252Q50 367 117 473T286 641T490 704Q580 704 633 653Q642 643 648 636T656 626L657 623Q660 623 684 649Q691 655 699 663T715 679T725 690L740 705H746Q760 705 760 698Q760 694 728 561Q692 422 692 421Q690 416 687 415T669 413H653Q647 419 647 422Q647 423 648 429T650 449T651 481Q651 552 619 605T510 659Q484 659 454 652T382 628T299 572T226 479Q194 422 175 346T156 222Q156 108 232 58Q280 24 350 24Q441 24 512 92T606 240Q610 253 612 255T628 257Q648 257 648 248Q648 243 647 239Q618 132 523 55T319 -22Q206 -22 128 53T50 252Z\"></path>\n<path stroke-width=\"1\" id=\"E1-MJMATHI-54\" d=\"M40 437Q21 437 21 445Q21 450 37 501T71 602L88 651Q93 669 101 677H569H659Q691 677 697 676T704 667Q704 661 687 553T668 444Q668 437 649 437Q640 437 637 437T631 442L629 445Q629 451 635 490T641 551Q641 586 628 604T573 629Q568 630 515 631Q469 631 457 630T439 622Q438 621 368 343T298 60Q298 48 386 46Q418 46 427 45T436 36Q436 31 433 22Q429 4 424 1L422 0Q419 0 415 0Q410 0 363 1T228 2Q99 2 64 0H49Q43 6 43 9T45 27Q49 40 55 46H83H94Q174 46 189 55Q190 56 191 56Q196 59 201 76T241 233Q258 301 269 344Q339 619 339 625Q339 630 310 630H279Q212 630 191 624Q146 614 121 583T67 467Q60 445 57 441T43 437H40Z\"></path>\n<path stroke-width=\"1\" id=\"E1-MJMATHI-74\" d=\"M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z\"></path>\n<path stroke-width=\"1\" id=\"E1-MJMATHI-6F\" d=\"M201 -11Q126 -11 80 38T34 156Q34 221 64 279T146 380Q222 441 301 441Q333 441 341 440Q354 437 367 433T402 417T438 387T464 338T476 268Q476 161 390 75T201 -11ZM121 120Q121 70 147 48T206 26Q250 26 289 58T351 142Q360 163 374 216T388 308Q388 352 370 375Q346 405 306 405Q243 405 195 347Q158 303 140 230T121 120Z\"></path>\n<path stroke-width=\"1\" id=\"E1-MJMATHI-70\" d=\"M23 287Q24 290 25 295T30 317T40 348T55 381T75 411T101 433T134 442Q209 442 230 378L240 387Q302 442 358 442Q423 442 460 395T497 281Q497 173 421 82T249 -10Q227 -10 210 -4Q199 1 187 11T168 28L161 36Q160 35 139 -51T118 -138Q118 -144 126 -145T163 -148H188Q194 -155 194 -157T191 -175Q188 -187 185 -190T172 -194Q170 -194 161 -194T127 -193T65 -192Q-5 -192 -24 -194H-32Q-39 -187 -39 -183Q-37 -156 -26 -148H-6Q28 -147 33 -136Q36 -130 94 103T155 350Q156 355 156 364Q156 405 131 405Q109 405 94 377T71 316T59 280Q57 278 43 278H29Q23 284 23 287ZM178 102Q200 26 252 26Q282 26 310 49T356 107Q374 141 392 215T411 325V331Q411 405 350 405Q339 405 328 402T306 393T286 380T269 365T254 350T243 336T235 326L232 322Q232 321 229 308T218 264T204 212Q178 106 178 102Z\"></path>\n<path stroke-width=\"1\" id=\"E1-MJMATHI-72\" d=\"M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q161 442 183 430T214 408T225 388Q227 382 228 382T236 389Q284 441 347 441H350Q398 441 422 400Q430 381 430 363Q430 333 417 315T391 292T366 288Q346 288 334 299T322 328Q322 376 378 392Q356 405 342 405Q286 405 239 331Q229 315 224 298T190 165Q156 25 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z\"></path>\n</defs>\n<g stroke=\"currentColor\" fill=\"currentColor\" stroke-width=\"0\" transform=\"matrix(1 0 0 -1 0 0)\" aria-hidden=\"true\">\n<text font-family=\"monospace\" stroke=\"none\" transform=\"scale(71.759) matrix(1 0 0 -1 0 0)\">原</text>\n<g transform=\"translate(932,0)\">\n<text font-family=\"monospace\" stroke=\"none\" transform=\"scale(71.759) matrix(1 0 0 -1 0 0)\">端</text>\n</g>\n<g transform=\"translate(1865,0)\">\n<text font-family=\"monospace\" stroke=\"none\" transform=\"scale(71.759) matrix(1 0 0 -1 0 0)\">口</text>\n</g>\n <use xlink:href=\"#E1-MJMAIN-22\" x=\"3076\" y=\"0\"></use>\n <use xlink:href=\"#E1-MJMAIN-2212\" x=\"3854\" y=\"0\"></use>\n <use xlink:href=\"#E1-MJMATHI-6A\" x=\"4633\" y=\"0\"></use>\n <use xlink:href=\"#E1-MJMATHI-52\" x=\"5045\" y=\"0\"></use>\n <use xlink:href=\"#E1-MJMATHI-45\" x=\"5805\" y=\"0\"></use>\n <use xlink:href=\"#E1-MJMATHI-44\" x=\"6569\" y=\"0\"></use>\n <use xlink:href=\"#E1-MJMATHI-49\" x=\"7398\" y=\"0\"></use>\n <use xlink:href=\"#E1-MJMATHI-52\" x=\"7902\" y=\"0\"></use>\n <use xlink:href=\"#E1-MJMATHI-45\" x=\"8662\" y=\"0\"></use>\n <use xlink:href=\"#E1-MJMATHI-43\" x=\"9426\" y=\"0\"></use>\n <use xlink:href=\"#E1-MJMATHI-54\" x=\"10187\" y=\"0\"></use>\n <use xlink:href=\"#E1-MJMAIN-2212\" x=\"11113\" y=\"0\"></use>\n <use xlink:href=\"#E1-MJMAIN-2212\" x=\"12114\" y=\"0\"></use>\n <use xlink:href=\"#E1-MJMATHI-74\" x=\"12893\" y=\"0\"></use>\n <use xlink:href=\"#E1-MJMATHI-6F\" x=\"13254\" y=\"0\"></use>\n <use xlink:href=\"#E1-MJMAIN-2212\" x=\"13962\" y=\"0\"></use>\n <use xlink:href=\"#E1-MJMATHI-70\" x=\"14963\" y=\"0\"></use>\n <use xlink:href=\"#E1-MJMATHI-6F\" x=\"15466\" y=\"0\"></use>\n <use xlink:href=\"#E1-MJMATHI-72\" x=\"15952\" y=\"0\"></use>\n <use xlink:href=\"#E1-MJMATHI-74\" x=\"16403\" y=\"0\"></use>\n <use xlink:href=\"#E1-MJMAIN-22\" x=\"17042\" y=\"0\"></use>\n</g>\n</svg>目标端口&quot;</span><br></code></pre></td></tr></table></figure>\n\n<blockquote>\n<p><strong>参数释义：</strong><br>-t: table  table to manipulate (default: &#96;filter’)<br>-A: 向规则链中添加条目<br>PREROUTING链：用于目标地址转换（DNAT），路由前。<br>-p：指定要匹配的数据包协议类型；<br>–dport: 目的端口，即客户端要访问的端口<br>-j: jump 指定要跳转的目标<br>REDIRECT: 重定向、映射、透明代理<br>–to-port: 跳转到的端口号</p>\n</blockquote>\n<p>以本次要解决的问题为例，外网输入网址–访问80端口–内部转发至8080端口–获取对 nextcloud 服务的访问</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">iptables -t nat -A PREROUTING -p tcp --dport 80 -j REDIRECT --to-port 8080<br></code></pre></td></tr></table></figure>\n\n<p>保存配置</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">service iptables save<br></code></pre></td></tr></table></figure>\n\n<ol start=\"4\">\n<li>查询与撤销操作</li>\n</ol>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">sudo iptables -t nat -nL --line<br></code></pre></td></tr></table></figure>\n\n<p>找到 <code>Chain PREROUTING (policy ACCEPT)</code> 这一栏，注意查看 <code>num</code> 序号</p>\n<p>删除指定表的指定链上的规则， -D 并指定对应序号即可（对应的序号会及时变动）。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">iptables -t nat -D PREROUTING 1<br></code></pre></td></tr></table></figure>\n\n<h2 id=\"彩蛋：高级玩法\"><a href=\"#彩蛋：高级玩法\" class=\"headerlink\" title=\"彩蛋：高级玩法\"></a>彩蛋：高级玩法</h2><p>一点小思考：明白了内网中转的办法，想到一个场景，通过一台远程主机管理另一台远程主机，相当于一台跳板，不过前提是两台主机都要有固定 ip 才行吧！</p>\n<p>要是未来 ipv6 全面普及了，估计能解放不少生产力！</p>\n<p>这个网站可以测测自己是不是有 ipv6地址：<a target=\"_blank\" rel=\"noopener\" href=\"https://www.test-ipv6.com/\">IPv6 测试</a></p>\n<h2 id=\"Ref\"><a href=\"#Ref\" class=\"headerlink\" title=\"Ref\"></a>Ref</h2><ul>\n<li><a target=\"_blank\" rel=\"noopener\" href=\"https://zhuanlan.zhihu.com/p/165043421\">linux中通过iptables实现端口转发 - 知乎</a></li>\n<li><a target=\"_blank\" rel=\"noopener\" href=\"https://blog.csdn.net/qq_31586935/article/details/89446612\">Linux将8080端口转发到80端口_Evanism_小风铃的博客-CSDN博客</a></li>\n<li><a target=\"_blank\" rel=\"noopener\" href=\"https://www.cnblogs.com/xiaopaipai/p/11733291.html\">iptable实现端口转发 - 博客园</a></li>\n<li><a target=\"_blank\" rel=\"noopener\" href=\"https://blog.csdn.net/zhouguoqionghai/article/details/81947603\">iptables 端口转发_zhouguoqionghai的博客-CSDN博客</a></li>\n<li><a target=\"_blank\" rel=\"noopener\" href=\"https://blog.csdn.net/ZhouGuo520/article/details/111227084\">Linux 操作系统防火墙之iptables配置（centos系列）</a></li>\n</ul>\n<h2 id=\"Changelog\"><a href=\"#Changelog\" class=\"headerlink\" title=\"Changelog\"></a>Changelog</h2><ul>\n<li>210913 米斯特乌建立初稿</li>\n</ul>\n","categories":[{"name":"Linux","path":"api/categories/Linux.json"}],"tags":[{"name":"Linux","path":"api/tags/Linux.json"},{"name":"端口","path":"api/tags/端口.json"}]}