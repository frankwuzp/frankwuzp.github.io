{"title":"使用公钥连接 SSH","slug":"210820-使用公钥连接 SSH","date":"2021-08-20T04:00:00.000Z","updated":"2023-12-22T08:04:15.777Z","comments":true,"path":"api/articles/210820-使用公钥连接 SSH.json","realPath":null,"excerpt":"每次 ssh 登录服务器都要重新输入一次密码？记住密码又怕不安全？","covers":["data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg=="],"cover":"https://pic.wuzhiping.top/blog/202108201307723.png","content":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>每次 ssh 登录服务器都要重新输入一次密码？记住密码又怕不安全？一个更好的解决办法是使用公钥文件，只需一键点击，就可登录到远程服务器。</p>\n<h2 id=\"环境配置\"><a href=\"#环境配置\" class=\"headerlink\" title=\"环境配置\"></a>环境配置</h2><ul>\n<li><p>Win10 本地主机</p>\n</li>\n<li><p>远程 Linux 服务器</p>\n</li>\n<li><p>Xshell 客户端</p>\n</li>\n</ul>\n<h2 id=\"关键步骤\"><a href=\"#关键步骤\" class=\"headerlink\" title=\"关键步骤\"></a>关键步骤</h2><p>分为本地端和服务端，分别进行设置。</p>\n<h3 id=\"本地端\"><a href=\"#本地端\" class=\"headerlink\" title=\"本地端\"></a>本地端</h3><p>主要是生成本机的密钥，有两种方式，一种是Xshell 软件生成，另一种是通过一行代码。</p>\n<p><strong>方法一：Xshell 生成</strong></p>\n<ol>\n<li><p>新建连接 –&gt; 选择 <code>Public Key</code> 方式 –&gt; 浏览 –&gt; 用户密钥，点击 <code>生成</code>，软件会自动生成2048位的公共密钥</p>\n</li>\n<li><p>保存密钥到本机指定位置，推荐 <code>C:\\Users\\&lt;username&gt;\\.ssh</code>文件夹，还可以为密钥文件加密存储</p>\n</li>\n</ol>\n <img    class=\"lazyload\" data-original=\"https://pic.wuzhiping.top/blog/202108201144138.png\" src=\"data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==\"  width = \"80%\" height = \"80%\"   align=center /><span class=\"image-caption\">Xshell 生成的公共密钥</span>\n\n\n<p><strong>方法二</strong></p>\n<p>之前在 GitHub 登录时使用过，可输入下列命令，由系统自动生成，保存位置同样在 <code>C:\\Users\\&lt;username&gt;\\.ssh</code>文件夹</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">git config --global user.name <span class=\"hljs-string\">&quot;用户名&quot;</span> <span class=\"hljs-comment\">#GitHub登录时选用</span><br>git config --global user.email <span class=\"hljs-string\">&quot;邮箱地址&quot;</span> <span class=\"hljs-comment\">#GitHub登录时选用</span><br><br>ssh-keygen -t rsa -C <span class=\"hljs-string\">&#x27;上面的邮箱&#x27;</span><br></code></pre></td></tr></table></figure>\n\n\n<p>按照提示完成三次回车，即可生成 ssh key。通过查看 <code>C:\\Users\\&lt;username&gt;\\.ssh\\id_rsa.pub</code> 文件内容，获取到你的 SSH key</p>\n<h3 id=\"服务端\"><a href=\"#服务端\" class=\"headerlink\" title=\"服务端\"></a>服务端</h3><ol>\n<li>登录远程服务器，生成密钥对</li>\n</ol>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">ssh-keygen -t rsa<br></code></pre></td></tr></table></figure>\n\n\n<p><em>注：生成的密钥文件保存在<code>~/.ssh</code>文件夹内</em></p>\n<p>2.1 手动上传本地密钥到远程主机</p>\n<blockquote>\n<p>本段为根据 <a target=\"_blank\" rel=\"noopener\" href=\"https://wangdoc.com/ssh/key.html\">SSH 密钥登录</a> 增补的内容，只需一行代码，自动上传并完成 #2.2 手动的工作。</p>\n</blockquote>\n<p>使用 <code>ssh-copy-id</code> 命令：自动上传公钥</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">ssh-copy-id -i id_rsa_233 user@host<br></code></pre></td></tr></table></figure>\n\n<p><code>-i</code> 参数用来指定公钥文件，user是所要登录的账户名，host是服务器地址。</p>\n<p>公钥文件可以不指定路径和<code>.pub</code>后缀名，<code>ssh-copy-id</code>会自动在~&#x2F;.ssh目录里面寻找，要做的只是把公钥文件名写对。</p>\n<blockquote>\n<p>注意: ssh-copy-id是直接将公钥添加到authorized_keys文件的末尾。如果authorized_keys文件的末尾不是一个换行符，会导致新的公钥添加到前一个公钥的末尾，两个公钥连在一起，使得它们都无法生效。</p>\n</blockquote>\n<p>2.2 上传本地密钥到远程主机</p>\n<p>上传本地生成的 <code>id_rsa_233.pub</code> 密钥文件到远程主机，可以 <code>sftp</code> 上传（路径 <code>~/.ssh/</code> ），也可通过以下命令：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\">#本地主机上传命令</span><br>scp ~/.ssh/id_rsa_233.pub &lt;username&gt;@&lt;ip&gt;:/home/&lt;username&gt;/.ssh/id_rsa_233.pub<br></code></pre></td></tr></table></figure>\n\n\n<ol start=\"3\">\n<li>服务端授权</li>\n</ol>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">sudo <span class=\"hljs-built_in\">cat</span> ~/.ssh/id_rsa_233.pub &gt;&gt; authorized_keys<br><span class=\"hljs-built_in\">chmod</span> 600 authorized_keys<br></code></pre></td></tr></table></figure>\n\n<ol start=\"4\">\n<li>修改 sshd 配置文件</li>\n</ol>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">sudo nano /etc/ssh/sshd_config<br></code></pre></td></tr></table></figure>\n\n<p>在文件最末尾加入下列代码并保存：</p>\n<figure class=\"highlight txt\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs txt\">RSAAuthentication yes　　<br>PubkeyAuthentication yes　　<br>AuthorizedKeysFile /home/&lt;username&gt;/.ssh/authorized_keys <br># 会到当前用户下的authorized_keys文件中寻找key<br>## 如需要连两个账号，可在 `AuthorizedKeysFile`后加个空格继续填写，连 root 账号，根目录是在 `/root/.ssh/`<br>### 建议关闭密码登录<br>#PasswordAuthentication no<br></code></pre></td></tr></table></figure>\n\n\n<ol start=\"5\">\n<li>重启 sshd 服务</li>\n</ol>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">service sshd restart<br></code></pre></td></tr></table></figure>\n\n\n<p>至此，就可以在本机实现无密码登录服务端啦~</p>\n<h2 id=\"Ref\"><a href=\"#Ref\" class=\"headerlink\" title=\"Ref\"></a>Ref</h2><ul>\n<li><p><a target=\"_blank\" rel=\"noopener\" href=\"https://blog.csdn.net/weixin_37989267/article/details/106860979\">linux 密钥对 远程登录-CSDN博客</a></p>\n</li>\n<li><p><a target=\"_blank\" rel=\"noopener\" href=\"https://blog.csdn.net/xu_binfeng/article/details/84850826\">linux 远程登录SSH密钥及配置-CSDN博客</a></p>\n</li>\n<li><p><a target=\"_blank\" rel=\"noopener\" href=\"https://wangdoc.com/ssh/key.html\">SSH 密钥登录 - SSH 教程 - 网道</a></p>\n</li>\n</ul>\n<h2 id=\"Changelog\"><a href=\"#Changelog\" class=\"headerlink\" title=\"Changelog\"></a>Changelog</h2><ul>\n<li>210913 增补自动上传公钥的内容</li>\n<li>210825 订正上传到远程主机的有误表述</li>\n<li>210820 init</li>\n</ul>\n","more":"<h2 id=\"前言\"><a href=\"#前言\" class=\"headerlink\" title=\"前言\"></a>前言</h2><p>每次 ssh 登录服务器都要重新输入一次密码？记住密码又怕不安全？一个更好的解决办法是使用公钥文件，只需一键点击，就可登录到远程服务器。</p>\n<h2 id=\"环境配置\"><a href=\"#环境配置\" class=\"headerlink\" title=\"环境配置\"></a>环境配置</h2><ul>\n<li><p>Win10 本地主机</p>\n</li>\n<li><p>远程 Linux 服务器</p>\n</li>\n<li><p>Xshell 客户端</p>\n</li>\n</ul>\n<h2 id=\"关键步骤\"><a href=\"#关键步骤\" class=\"headerlink\" title=\"关键步骤\"></a>关键步骤</h2><p>分为本地端和服务端，分别进行设置。</p>\n<h3 id=\"本地端\"><a href=\"#本地端\" class=\"headerlink\" title=\"本地端\"></a>本地端</h3><p>主要是生成本机的密钥，有两种方式，一种是Xshell 软件生成，另一种是通过一行代码。</p>\n<p><strong>方法一：Xshell 生成</strong></p>\n<ol>\n<li><p>新建连接 –&gt; 选择 <code>Public Key</code> 方式 –&gt; 浏览 –&gt; 用户密钥，点击 <code>生成</code>，软件会自动生成2048位的公共密钥</p>\n</li>\n<li><p>保存密钥到本机指定位置，推荐 <code>C:\\Users\\&lt;username&gt;\\.ssh</code>文件夹，还可以为密钥文件加密存储</p>\n</li>\n</ol>\n <img  src=\"https://pic.wuzhiping.top/blog/202108201144138.png\" width = \"80%\" height = \"80%\"   align=center /><span class=\"image-caption\">Xshell 生成的公共密钥</span>\n\n\n<p><strong>方法二</strong></p>\n<p>之前在 GitHub 登录时使用过，可输入下列命令，由系统自动生成，保存位置同样在 <code>C:\\Users\\&lt;username&gt;\\.ssh</code>文件夹</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">git config --global user.name <span class=\"hljs-string\">&quot;用户名&quot;</span> <span class=\"hljs-comment\">#GitHub登录时选用</span><br>git config --global user.email <span class=\"hljs-string\">&quot;邮箱地址&quot;</span> <span class=\"hljs-comment\">#GitHub登录时选用</span><br><br>ssh-keygen -t rsa -C <span class=\"hljs-string\">&#x27;上面的邮箱&#x27;</span><br></code></pre></td></tr></table></figure>\n\n\n<p>按照提示完成三次回车，即可生成 ssh key。通过查看 <code>C:\\Users\\&lt;username&gt;\\.ssh\\id_rsa.pub</code> 文件内容，获取到你的 SSH key</p>\n<h3 id=\"服务端\"><a href=\"#服务端\" class=\"headerlink\" title=\"服务端\"></a>服务端</h3><ol>\n<li>登录远程服务器，生成密钥对</li>\n</ol>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">ssh-keygen -t rsa<br></code></pre></td></tr></table></figure>\n\n\n<p><em>注：生成的密钥文件保存在<code>~/.ssh</code>文件夹内</em></p>\n<p>2.1 手动上传本地密钥到远程主机</p>\n<blockquote>\n<p>本段为根据 <a target=\"_blank\" rel=\"noopener\" href=\"https://wangdoc.com/ssh/key.html\">SSH 密钥登录</a> 增补的内容，只需一行代码，自动上传并完成 #2.2 手动的工作。</p>\n</blockquote>\n<p>使用 <code>ssh-copy-id</code> 命令：自动上传公钥</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">ssh-copy-id -i id_rsa_233 user@host<br></code></pre></td></tr></table></figure>\n\n<p><code>-i</code> 参数用来指定公钥文件，user是所要登录的账户名，host是服务器地址。</p>\n<p>公钥文件可以不指定路径和<code>.pub</code>后缀名，<code>ssh-copy-id</code>会自动在~&#x2F;.ssh目录里面寻找，要做的只是把公钥文件名写对。</p>\n<blockquote>\n<p>注意: ssh-copy-id是直接将公钥添加到authorized_keys文件的末尾。如果authorized_keys文件的末尾不是一个换行符，会导致新的公钥添加到前一个公钥的末尾，两个公钥连在一起，使得它们都无法生效。</p>\n</blockquote>\n<p>2.2 上传本地密钥到远程主机</p>\n<p>上传本地生成的 <code>id_rsa_233.pub</code> 密钥文件到远程主机，可以 <code>sftp</code> 上传（路径 <code>~/.ssh/</code> ），也可通过以下命令：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-comment\">#本地主机上传命令</span><br>scp ~/.ssh/id_rsa_233.pub &lt;username&gt;@&lt;ip&gt;:/home/&lt;username&gt;/.ssh/id_rsa_233.pub<br></code></pre></td></tr></table></figure>\n\n\n<ol start=\"3\">\n<li>服务端授权</li>\n</ol>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">sudo <span class=\"hljs-built_in\">cat</span> ~/.ssh/id_rsa_233.pub &gt;&gt; authorized_keys<br><span class=\"hljs-built_in\">chmod</span> 600 authorized_keys<br></code></pre></td></tr></table></figure>\n\n<ol start=\"4\">\n<li>修改 sshd 配置文件</li>\n</ol>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">sudo nano /etc/ssh/sshd_config<br></code></pre></td></tr></table></figure>\n\n<p>在文件最末尾加入下列代码并保存：</p>\n<figure class=\"highlight txt\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs txt\">RSAAuthentication yes　　<br>PubkeyAuthentication yes　　<br>AuthorizedKeysFile /home/&lt;username&gt;/.ssh/authorized_keys <br># 会到当前用户下的authorized_keys文件中寻找key<br>## 如需要连两个账号，可在 `AuthorizedKeysFile`后加个空格继续填写，连 root 账号，根目录是在 `/root/.ssh/`<br>### 建议关闭密码登录<br>#PasswordAuthentication no<br></code></pre></td></tr></table></figure>\n\n\n<ol start=\"5\">\n<li>重启 sshd 服务</li>\n</ol>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">service sshd restart<br></code></pre></td></tr></table></figure>\n\n\n<p>至此，就可以在本机实现无密码登录服务端啦~</p>\n<h2 id=\"Ref\"><a href=\"#Ref\" class=\"headerlink\" title=\"Ref\"></a>Ref</h2><ul>\n<li><p><a target=\"_blank\" rel=\"noopener\" href=\"https://blog.csdn.net/weixin_37989267/article/details/106860979\">linux 密钥对 远程登录-CSDN博客</a></p>\n</li>\n<li><p><a target=\"_blank\" rel=\"noopener\" href=\"https://blog.csdn.net/xu_binfeng/article/details/84850826\">linux 远程登录SSH密钥及配置-CSDN博客</a></p>\n</li>\n<li><p><a target=\"_blank\" rel=\"noopener\" href=\"https://wangdoc.com/ssh/key.html\">SSH 密钥登录 - SSH 教程 - 网道</a></p>\n</li>\n</ul>\n<h2 id=\"Changelog\"><a href=\"#Changelog\" class=\"headerlink\" title=\"Changelog\"></a>Changelog</h2><ul>\n<li>210913 增补自动上传公钥的内容</li>\n<li>210825 订正上传到远程主机的有误表述</li>\n<li>210820 init</li>\n</ul>\n","categories":[{"name":"技术向","path":"api/categories/技术向.json"},{"name":"Linux","path":"api/categories/Linux.json"}],"tags":[{"name":"技术","path":"api/tags/技术.json"},{"name":"Linux","path":"api/tags/Linux.json"},{"name":"ssh","path":"api/tags/ssh.json"},{"name":"远程访问","path":"api/tags/远程访问.json"},{"name":"教程","path":"api/tags/教程.json"}]}